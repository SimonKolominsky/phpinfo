<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link href="../deepseek.css" rel="stylesheet">

</head>
<body>
<div class="ds-markdown ds-markdown--block" style="--ds-md-zoom: 1.143;"><p>Вот примеры агрегатов в DDD на PHP с пояснениями:</p><hr><h3>1. <strong>Агрегат "Заказ" (Order) в интернет-магазине</strong></h3><p><strong>Корень агрегата</strong>: <code>Order</code><br><strong>Внутренние объекты</strong>: <code>OrderItem</code>, <code>Money</code> (Value Object).</p><div class="md-code-block"><div class="md-code-block-banner-wrap"><div class="md-code-block-banner"><div class="md-code-block-infostring">php</div><div class="md-code-block-action"><div class="ds-markdown-code-copy-button">Copy</div></div></div></div><pre><span class="token keyword">class</span> <span class="token class-name-definition class-name">Order</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name type-declaration">OrderId</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
    <span class="token comment">/** @var OrderItem[] */</span>
    <span class="token keyword">private</span> <span class="token keyword type-declaration">array</span> <span class="token variable">$items</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name type-declaration">Money</span> <span class="token variable">$total</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword type-declaration">bool</span> <span class="token variable">$isConfirmed</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">OrderId</span> <span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">id</span> <span class="token operator">=</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">total</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'USD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Добавление товара через агрегатный корень</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addItem</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Product</span> <span class="token variable">$product</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$quantity</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isConfirmed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DomainException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Cannot modify confirmed order.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$item</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token variable">$product</span><span class="token operator">-&gt;</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$product</span><span class="token operator">-&gt;</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$quantity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">items</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$item</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">total</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">total</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token operator">-&gt;</span><span class="token function">getSubtotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Удаление товара</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">removeItem</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ProductId</span> <span class="token variable">$productId</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">items</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$item</span><span class="token operator">-&gt;</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token variable">$productId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">items</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">total</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">total</span><span class="token operator">-&gt;</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token operator">-&gt;</span><span class="token function">getSubtotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Подтверждение заказа</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">confirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">items</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DomainException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Empty order cannot be confirmed.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isConfirmed</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Value Object: Деньги</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Money</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">float</span> <span class="token variable">$amount</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">string</span> <span class="token variable">$currency</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Money</span> <span class="token variable">$other</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">self</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">currency</span> <span class="token operator">!==</span> <span class="token variable">$other</span><span class="token operator">-&gt;</span><span class="token property">currency</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>InvalidArgumentException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Currencies must match.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">self</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">amount</span> <span class="token operator">+</span> <span class="token variable">$other</span><span class="token operator">-&gt;</span><span class="token property">amount</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">currency</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Сущность внутри агрегата</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">OrderItem</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token class-name type-declaration">ProductId</span> <span class="token variable">$productId</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token class-name type-declaration">Money</span> <span class="token variable">$price</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">int</span> <span class="token variable">$quantity</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getSubtotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Money</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">price</span><span class="token operator">-&gt;</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">quantity</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">price</span><span class="token operator">-&gt;</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div><p><strong>Инварианты</strong>:</p><ul><li><p>Нельзя изменить подтвержденный заказ.</p></li><li><p>Сумма заказа автоматически пересчитывается при добавлении/удалении товаров.</p></li><li><p>Заказ не может быть пустым при подтверждении.</p></li></ul><hr><h3>2. <strong>Агрегат "Пользователь" (User) с адресами доставки</strong></h3><p><strong>Корень агрегата</strong>: <code>User</code><br><strong>Внутренние объекты</strong>: <code>Address</code> (Value Object).</p><div class="md-code-block"><div class="md-code-block-banner-wrap"><div class="md-code-block-banner"><div class="md-code-block-infostring">php</div><div class="md-code-block-action"><div class="ds-markdown-code-copy-button">Copy</div></div></div></div><pre><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name type-declaration">UserId</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
    <span class="token comment">/** @var Address[] */</span>
    <span class="token keyword">private</span> <span class="token keyword type-declaration">array</span> <span class="token variable">$addresses</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addAddress</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Address</span> <span class="token variable">$address</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">addresses</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DomainException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Maximum 5 addresses allowed.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">addresses</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">removeAddress</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Address</span> <span class="token variable">$addressToRemove</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">addresses</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$address</span><span class="token operator">-&gt;</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token variable">$addressToRemove</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">addresses</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DomainException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Address not found.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Value Object: Адрес</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Address</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">string</span> <span class="token variable">$street</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">string</span> <span class="token variable">$city</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">string</span> <span class="token variable">$zipCode</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">equals</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Address</span> <span class="token variable">$other</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">street</span> <span class="token operator">===</span> <span class="token variable">$other</span><span class="token operator">-&gt;</span><span class="token property">street</span>
            <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">city</span> <span class="token operator">===</span> <span class="token variable">$other</span><span class="token operator">-&gt;</span><span class="token property">city</span>
            <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zipCode</span> <span class="token operator">===</span> <span class="token variable">$other</span><span class="token operator">-&gt;</span><span class="token property">zipCode</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div><p><strong>Инварианты</strong>:</p><ul><li><p>У пользователя не может быть больше 5 адресов.</p></li><li><p>Удаление возможно только существующего адреса.</p></li></ul><hr><h3>3. <strong>Агрегат "Статья блога" (BlogPost) с комментариями</strong></h3><p><strong>Корень агрегата</strong>: <code>BlogPost</code><br><strong>Внутренние объекты</strong>: <code>Comment</code>.</p><div class="md-code-block"><div class="md-code-block-banner-wrap"><div class="md-code-block-banner"><div class="md-code-block-infostring">php</div><div class="md-code-block-action"><div class="ds-markdown-code-copy-button">Copy</div></div></div></div><pre><span class="token keyword">class</span> <span class="token class-name-definition class-name">BlogPost</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name type-declaration">BlogPostId</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
    <span class="token comment">/** @var Comment[] */</span>
    <span class="token keyword">private</span> <span class="token keyword type-declaration">array</span> <span class="token variable">$comments</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword type-declaration">bool</span> <span class="token variable">$isPublished</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isPublished</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addComment</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Comment</span> <span class="token variable">$comment</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isPublished</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DomainException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Cannot add comment to unpublished post.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">comments</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$comment</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">deleteComment</span><span class="token punctuation">(</span><span class="token class-name type-declaration">CommentId</span> <span class="token variable">$commentId</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">comments</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$comment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$comment</span><span class="token operator">-&gt;</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token variable">$commentId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">comments</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>DomainException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Comment not found.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Сущность внутри агрегата</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Comment</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> <span class="token class-name type-declaration">CommentId</span> <span class="token variable">$id</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> <span class="token keyword type-declaration">string</span> <span class="token variable">$text</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div><p><strong>Инварианты</strong>:</p><ul><li><p>Нельзя добавить комментарий к неопубликованной статье.</p></li><li><p>Удаление комментария возможно только через агрегатный корень.</p></li></ul><hr><h3>Ключевые особенности агрегатов:</h3><ol start="1"><li><p><strong>Контроль доступа</strong>: Внешний код взаимодействует только с корнем агрегата.</p></li><li><p><strong>Инкапсуляция бизнес-правил</strong>: Например, проверка максимального количества адресов в <code>User</code>.</p></li><li><p><strong>Целостность данных</strong>: Автоматический пересчет суммы заказа при изменении товаров.</p></li><li><p><strong>Границы транзакций</strong>: Изменения внутри агрегата обычно сохраняются атомарно.</p></li></ol><p>Такая организация помогает управлять сложностью в PHP-приложениях с насыщенной бизнес-логикой.</p></div>
</body>
</html>
